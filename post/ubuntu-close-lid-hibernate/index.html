<!doctype html><html lang=zh-hans><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Source Themes Academic 4.5.0"><meta name=author content=贾海波><meta name=description content="背景 不知道从什么时候开始, 就逐渐喜欢上了电脑不关机, 打开盖子一切都是上次关闭的样子, 马上就可以开始继续干活. Windows, Mac和Linux我都用过, M"><link rel=alternate hreflang=zh-hans href=https://bluethon.me/post/ubuntu-close-lid-hibernate/><meta name=theme-color content=#2962ff><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.6.0/css/all.css integrity=sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/monokai-sublime.min.css crossorigin=anonymous title=hl-light><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/monokai-sublime.min.css crossorigin=anonymous title=hl-dark disabled><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap"><link rel=stylesheet href=/css/academic.min.a3cda781a9b24f26fefd34a53547835b.css><link rel=manifest href=/index.webmanifest><link rel=icon type=image/png href=/img/icon-32.png><link rel=apple-touch-icon type=image/png href=/img/icon-192.png><link rel=canonical href=https://bluethon.me/post/ubuntu-close-lid-hibernate/><meta property=twitter:card content=summary><meta property=og:site_name content=Bluethon的小站><meta property=og:url content=https://bluethon.me/post/ubuntu-close-lid-hibernate/><meta property=og:title content="Ubuntu笔记本合盖休眠 | Bluethon的小站"><meta property=og:description content="背景 不知道从什么时候开始, 就逐渐喜欢上了电脑不关机, 打开盖子一切都是上次关闭的样子, 马上就可以开始继续干活. Windows, Mac和Linux我都用过, M"><meta property=og:image content=https://bluethon.me/img/icon-192.png><meta property=twitter:image content=https://bluethon.me/img/icon-192.png><meta property=og:locale content=zh-Hans><meta property=article:published_time content=2019-11-15T20:59:24&#43;08:00><meta property=article:modified_time content=2019-11-15T22:27:05&#43;08:00><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://bluethon.me/post/ubuntu-close-lid-hibernate/"},"headline":"Ubuntu笔记本合盖休眠","datePublished":"2019-11-15T20:59:24+08:00","dateModified":"2019-11-15T22:27:05+08:00","author":{"@type":"Person","name":"贾海波"},"publisher":{"@type":"Organization","name":"Bluethon的小站","logo":{"@type":"ImageObject","url":"https://bluethon.me/img/icon-512.png"}},"description":"背景 不知道从什么时候开始, 就逐渐喜欢上了电脑不关机, 打开盖子一切都是上次关闭的样子, 马上就可以开始继续干活. Windows, Mac和Linux我都用过, M"}</script><title>Ubuntu笔记本合盖休眠 | Bluethon的小站</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents><aside class=search-results id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>搜索</h1></div><div class="col-6 col-search-close"><a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=搜索... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><nav class="navbar navbar-light fixed-top navbar-expand-lg py-0 compensate-for-scrollbar" id=navbar-main><div class=container><a class=navbar-brand href=/>Bluethon的小站</a>
<button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar aria-controls=navbar aria-expanded=false aria-label=切换导航>
<span><i class="fas fa-bars"></i></span></button><div class="collapse navbar-collapse" id=navbar><ul class="navbar-nav ml-auto"><li class=nav-item><a class="nav-link  active" href=/><span>首页</span></a></li><li class=nav-item><a class="nav-link  active" href=/post><span>技术文章</span></a></li><li class=nav-item><a class=nav-link href=/teach><span>教学笔记</span></a></li><li class=nav-item><a class=nav-link href=/#about><span>关于</span></a></li><li class=nav-item><a class="nav-link js-search" href=#><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link js-dark-toggle" href=#><i class="fas fa-moon" aria-hidden=true></i></a></li></ul></div></div></nav><article class=article><div class="article-container pt-3"><h1>Ubuntu笔记本合盖休眠</h1><div class=article-metadata><span class=article-date>最近更新于
2019-11-15</span></div></div><div class=article-container><div class=article-style><h2 id=背景>背景</h2><p>不知道从什么时候开始, 就逐渐喜欢上了电脑不关机, 打开盖子一切都是上次关闭的样子, 马上就可以开始继续干活. Windows, Mac和Linux我都用过, Mac合盖并不会关机, 但是由于其较为卓越的电源管理和电池, 所以基本可以做到用完就合盖, 打开接着干, 确实非常方便, Windows的话, 在Win10+SSD的加持下, 打开休眠选项并设置合盖即休眠可以非常简单就达到效果, 所以win10下除了不时的更新强制重启外我也很少关机, 都是用完一合盖子拉倒</p><p>就Linux下, 或者Ubuntu来说, 这个功能是没有的, 有的是一个<code>suspend</code>的功能, 但是在我看来这个更像是深一点的睡眠功能, 类似Mac? 总之不时很满意, 因为我的笔记本是一个老式的二手ThinkPad, 电池并不好, 所以经常会在<code>suspend</code>一段时间后关机, 所有的工作场景都没了, 开机还得从头来过, 非常不爽, 之前一直想找时间给ubuntu加上这块, 最近因为又开始给老婆写一个PDF转换工具, 突突突搞了几天, 趁着休息的空挡搞了一下, 然后记录一下过程和坑</p><h2 id=正片>正片</h2><p>首先声明, 本文是在Ubuntu 19.10环境下写的, 在我的机子上测试通过</p><h3 id=测试>测试</h3><p>首先测试是否支持休眠, 注意以下命令会导致休眠, 如果功能不完整(比如我), 会导致无法正确保存当前任务, 请先处理好后再测试</p><pre><code>sudo systemctl hibernate
</code></pre><p>如果没有成功, 那估计是没有设置<code>swap</code>分区导致的, 这块我也不是特别清除, 因为这块我是没有问题的</p><p>另外注意是的, swap的大小最好略大于内存, 否则无法报错内存数据, 可能会在某些场景下休眠失败</p><p>如果有这个命令, 但是开机后还是和重启了一样, 那么恭喜, 我们可以进入下一个环节了</p><h3 id=设置swap保存内存数据>设置swap保存内存数据</h3><p>首先找到swap的文件路径</p><pre><code>grep swap /etc/fstab
</code></pre><p>找到类似如下内容</p><pre><code>/dev/mapper/ubuntu--vg-swap   none            swap    sw
</code></pre><p><code>/dev/mapper/ubuntu--vg-swap</code>即为swap分区路径(我用的lvm, 此处格式可能会有差异)</p><p>添加启动参数</p><pre><code>sudo vim /etc/default/grub
</code></pre><p>在<code>GRUB_CMDLINE_LINUX_DEFAULT</code>字段中增加如下内容, 注意替换路径为你的swap路径, 这个字段我之前修改过, 如果你没有修改, 此处应该还有<code>quiet splash</code>的字样, 删掉这两个字段可以让开机时显示详细开机信息, 我比较喜欢看开机的信息, 比只盯着Ubuntu的那个LOGO看感觉上要好点, 如果你有, 那么就加在末尾就好了, 空格分割</p><p>这里有个坑就是, 我开始在网上找的都是使用的swap的UUID, 然而我自己的测试是不能成功, 使用文件路径可以, 不知道是不是我哪里弄错了, 如果你用路径不成功, 可以换UUID试一下</p><pre><code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;resume=/dev/mapper/ubuntu--vg-swap&quot;
</code></pre><p>OK, 接下来就是执行<code>sudo update-grub</code>让启动项的设置生效, 这个很重要, 我自己设置的时候就是这个地方开始没有注意到, 导致失败, 然后重启, 进入系统后, 可以继续执行我们最开始的命令测试了</p><pre><code>sudo systemctl hibernate
</code></pre><p>等电源灯熄灭后开机, 如果一切正常, 此时开机后就会恢复上次休眠时的内容了, 搞定</p><h2 id=合盖休眠>合盖休眠</h2><p>到这步为止, 系统已经可以正常休眠了, 但是每次敲命令肯定是有点不方便的, 那么我们接下来就是设置笔记本的合盖休眠了</p><p>这里有两个途径, 一个是使用<code>dconf</code>设置, 我测试没有成功, 此处介绍另一种, 直接修改文件</p><h3 id=设置dconf>设置dconf</h3><p>首先是设置dconf, 如果你没有设置过, 先安装设置工具</p><pre><code>sudo apt install dconf-editor
</code></pre><p>打开如下路径<code>/org/gnome/settings-daemon/plugins/power/</code></p><ul><li>设置<code>lid-close-ac-action</code> -&gt; <code>nothing</code></li><li>设置<code>lid-close-battery-action</code> -&gt; <code>nothing</code></li></ul><p>此处还可以设置为挂起(suspend)或者睡眠, 但是设置为休眠时无效, 所以为了使用文件方式, 此处设置为<code>nothing</code></p><p>接下来修改文件</p><pre><code>sudo vim /etc/systemd/logind.conf
</code></pre><p>取消注释如下两行, 并修改值为<code>hibernate</code></p><pre><code>HandleLidSwitch=hibernate
# HandleLidSwitch=suspend-then-hibernate    # 此值为先挂起一段时间后休眠
HandleLidSwitchDocked=hibernate     # 此处为外接显示器时合盖操作, 但我测试没有生效, 如果没有外接显示器, 可不设置
</code></pre><p>重启服务</p><pre><code>sudo systemctl restart systemd-logind.service
</code></pre><h3 id=添加顶部菜单休眠键>添加顶部菜单休眠键</h3><p>创建设置文件</p><pre><code>sudo vim /etc/polkit-1/localauthority/50-local.d/enable-hibernate.pkla
</code></pre><p>添加如下内容</p><pre><code class=language-conf>[Re-enable hibernate by default in upower]
Identity=unix-user:*
Action=org.freedesktop.upower.hibernate
ResultActive=yes

[Re-enable hibernate by default in logind]
Identity=unix-user:*
Action=org.freedesktop.login1.hibernate;org.freedesktop.login1.handle-hibernate-key;org.freedesktop.login1;org.freedesktop.login1.hibernate-multiple-sessions;org.freedesktop.login1.hibernate-ignore-inhibit
ResultActive=yes
</code></pre><p>如果是较新的使用gnome的Ubuntu版本, 添加<a href=https://extensions.gnome.org/extension/755/hibernate-status-button/&gt; target=_blank>扩展</a>, 然后就顶部菜单栏就会出现休眠按钮, 大功告成</p><h2 id=todo>TODO</h2><ul><li>外接显示器的合盖操作一直没有成功</li><li>合盖休眠再打开会直接开机, 目前我没有设置关闭此功能, 后续看需求测试一下, 也给出<a href=https://superuser.com/a/68079/603441&gt; target=_blank>参考地址</a></li></ul><h2 id=参考>参考</h2><blockquote><ul><li><a href=https://askubuntu.com/a/821122/537695 target=_blank>https://askubuntu.com/a/821122/537695</a></li><li><a href=https://askubuntu.com/a/94963/537695 target=_blank>https://askubuntu.com/a/94963/537695</a></li><li><a href=http://tipsonubuntu.com/2016/10/24/ubuntu-16-10-auto-shutdown-hibernate-lid-closed/ target=_blank>http://tipsonubuntu.com/2016/10/24/ubuntu-16-10-auto-shutdown-hibernate-lid-closed/</a></li></ul></blockquote></div><div class=article-tags><a class="badge badge-light" href=/tags/ubuntu/>ubuntu</a>
<a class="badge badge-light" href=/tags/hibernate/>hibernate</a></div><div class="media author-card"><img class="portrait mr-3" src=/authors/admin/avatar_huf8edac94af8270b8678c9cb19bcfaa68_38480_250x250_fill_lanczos_center_2.png alt=Avatar><div class=media-body><h5 class=card-title><a href=https://bluethon.me/>贾海波</a></h5><h6 class=card-subtitle>业余程序员</h6><p class=card-text>一个想写点代码的人</p><ul class=network-icon aria-hidden=true><li><a href=mailto:j5088794@gmail.com><i class="fas fa-envelope"></i></a></li><li><a href=https://github.com/bluethon target=_blank rel=noopener><i class="fab fa-github"></i></a></li></ul></div></div></div></article><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/bash.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/dockerfile.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/makefile.min.js></script><script>hljs.initHighlightingOnLoad();</script><script>const search_index_filename="/index.json";const i18n={'placeholder':"搜索...",'results':"搜索结果",'no_results':"没有找到结果"};const content_type={'post':"文章",'project':"项目",'publication':"出版物",'talk':"演讲"};</script><script id=search-hit-fuse-template type=text/x-template>
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script><script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script><script src=/js/academic.min.0bf1e3db85cbb232372ed31d6f10dc70.js></script><div class=container><footer class=site-footer><p class=powered-by>&copy; 2019-2020 Bluethon &middot;
Powered by the
<a href=https://sourcethemes.com/academic/ target=_blank rel=noopener>Academic theme</a> for
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a>.
<span class=float-right aria-hidden=true><a href=# class=back-to-top><span class=button_icon><i class="fas fa-chevron-up fa-2x"></i></span></a></span></p></footer></div><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>引用</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&times;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i>复制</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i>下载</a><div id=modal-error></div></div></div></div></div></body></html>